@page "/transactions/create"
@using Microsoft.AspNetCore.Authorization
@using System.ComponentModel.DataAnnotations
@using Verity.Contracts
@using Verity.Web.DTOs
@using Verity.Web.Services
@attribute [Authorize]
@inject TransactionService TransactionService
@inject NavigationManager NavigationManager

<PageTitle>Novo Lançamento - Verity CashFlow</PageTitle>

<div class="mb-4">
    <a href="transactions" class="btn btn-link text-decoration-none ps-0 mb-3 d-inline-flex align-items-center text-muted hover-primary">
        <span class="bi bi-chevron-left me-2"></span>
        <span class="fw-semibold">Voltar para Extrato</span>
    </a>
    <h1 class="display-6 fw-bold text-dark">Novo Lançamento</h1>
    <p class="text-muted">Registre uma nova movimentação financeira</p>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8 col-xl-7">

        <div class="card shadow-sm border-0 rounded-4">
            <div class="card-body p-5">
                <EditForm Model="@transactionModel" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
                            <span class="bi bi-exclamation-triangle me-2"></span> @errorMessage
                        </div>
                    }

                    <div class="mb-4">
                        <label for="description" class="form-label text-uppercase small fw-bold text-muted mb-2">Descrição</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-white border-end-0 text-muted ps-3">
                                <span class="bi bi-file-text"></span>
                            </span>
                            <InputText id="description" class="form-control border-start-0 ps-0" @bind-Value="transactionModel.Description" placeholder="Ex: Pagamento de Fornecedor" />
                        </div>
                        <ValidationMessage For="@(() => transactionModel.Description)" class="text-danger small mt-1" />
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="amount" class="form-label text-uppercase small fw-bold text-muted mb-2">Valor (R$)</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-white border-end-0 text-muted ps-3">R$</span>
                                <InputNumber id="amount" class="form-control border-start-0 ps-0" @bind-Value="transactionModel.Amount" placeholder="0,00" />
                            </div>
                            <ValidationMessage For="@(() => transactionModel.Amount)" class="text-danger small mt-1" />
                        </div>
                        <div class="col-md-6">
                            <label for="type" class="form-label text-uppercase small fw-bold text-muted mb-2">Tipo de Transação</label>
                            <div class="input-group input-group-lg">
                                <label class="input-group-text bg-white border-end-0 text-muted ps-3" for="type">
                                    <span class="bi bi-arrow-left-right"></span>
                                </label>
                                <InputSelect id="type" class="form-select border-start-0 ps-0" @bind-Value="transactionModel.Type">
                                    <option value="@TransactionType.Credit">Crédito (Entrada)</option>
                                    <option value="@TransactionType.Debit">Débito (Saída)</option>
                                </InputSelect>
                            </div>
                            <ValidationMessage For="@(() => transactionModel.Type)" class="text-danger small mt-1" />
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg shadow-sm py-3 fw-bold" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Processando...</span>
                            }
                            else
                            {
                                <span><span class="bi bi-check-lg me-2"></span> Lançar Movimento</span>
                            }
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    private CreateTransactionRequest transactionModel = new();
    private bool isSubmitting = false;
    private string? errorMessage;

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        errorMessage = null;

        try
        {
            var success = await TransactionService.CreateTransactionAsync(transactionModel);
            if (success)
            {
                await Task.Delay(500); 
                NavigationManager.NavigateTo("");
            }
            else
            {
                errorMessage = "Ocorreu um erro ao processar o lançamento. Tente novamente.";
            }
        }
        catch (Exception)
        {
            errorMessage = "Erro de conexão com o servidor.";
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
